<!DOCTYPE html>
<html>
<head>
  <title>NER Author Name Normalizer</title>
  <style>
    body { 
      font-family: -moz-dialog, Arial, sans-serif; 
      padding: 20px; 
      margin: 0; 
      background: #f9f9f9;
      color: #333;
    }
    h1 { margin-top: 0; }
    .summary { 
      background: #e8f4fd; 
      padding: 15px; 
      margin: 10px 0; 
      border: 1px solid #b3d9ff; 
      border-radius: 4px; 
    }
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .variant-group { 
      margin: 15px 0; 
      padding: 15px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      background: white;
    }
    .variant-group h4 { margin: 0 0 10px 0; color: #0066cc; }
    .primary { 
      font-weight: bold; 
      color: #0066cc; 
      margin-bottom: 10px;
      padding: 5px;
      background: #f0f8ff;
      border-radius: 3px;
    }
    .variants-list {
      list-style: none;
      padding: 0;
    }
    .variant {
      margin: 5px 0;
      padding: 5px;
      background: #f9f9f9;
      border-radius: 3px;
    }
    .frequency { 
      color: #666; 
      font-size: 0.9em; 
      font-style: italic;
    }
    .radio-group {
      margin: 10px 0;
    }
    .radio-group input[type="radio"] {
      margin-right: 5px;
    }
    .confidence {
      font-size: 0.9em;
      color: #007acc;
      font-weight: bold;
    }
    button { 
      margin: 10px 5px; 
      padding: 8px 16px; 
      border: 1px solid #ccc; 
      border-radius: 3px;
      background: #f0f0f0;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #e0e0e0;
    }
    .progress { 
      margin: 10px 0; 
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .progress-bar { 
      flex: 1; 
      height: 20px; 
      background: #f0f0f0; 
      border-radius: 10px; 
      overflow: hidden;
      border: 1px solid #ccc;
    }
    .progress-fill { 
      height: 100%; 
      background: linear-gradient(90deg, #0066cc, #007acc); 
      transition: width 0.3s ease;
      width: 0%;
    }
    .empty-message {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }
    .empty-message-content {
      text-align: left;
      color: #444;
      font-style: normal;
    }
    .empty-message-content p {
      margin: 8px 0;
    }
    .surname-frequency-list {
      list-style: disc;
      padding-left: 20px;
      margin: 6px 0 0 0;
    }
    .surname-frequency-list li {
      margin: 4px 0;
    }
    .surname-frequency-list .surname {
      font-weight: 600;
      color: #222;
    }
    #progress-container { display: none; }
    #suggestions-container:empty::after {
      content: "No suggestions to display.";
      display: block;
      text-align: center;
      color: #666;
      padding: 20px;
    }
    .selected {
      background-color: #e3f2fd;
      border-color: #2196f3;
    }
  </style>
</head>
<body>
  <h1>NER Author Name Normalizer</h1>
  <p>Review and apply author name normalizations for your library.</p>

  <!-- Summary header for full-library analysis -->
  <div id="summary-group" class="summary" style="display: none;">
    <h3>Library Analysis Summary</h3>
    <div class="summary-grid">
      <div><strong>Unique surnames:</strong> <span id="summary-total-creators">Loading...</span></div>
      <div><strong>Variant groups:</strong> <span id="summary-variant-groups">Loading...</span></div>
      <div><strong>Pending normalizations:</strong> <span id="summary-pending-normalizations">Loading...</span></div>
    </div>
  </div>

  <!-- Progress indicator for batch processing -->
  <div id="progress-container" class="progress">
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill"></div>
    </div>
    <span id="progress-label">Processing...</span>
  </div>

  <!-- Variant groups list -->
  <div id="variant-groups" style="margin: 20px 0;">
    <h3>Creator Variant Groups</h3>
    <p id="variant-groups-description">Review variant groups discovered in your library. Each entry represents multiple creator spellings that may refer to the same person.</p>
    <ul id="variant-group-list" style="list-style: none; padding: 0;">
      <!-- Variant groups will be dynamically populated here -->
    </ul>
  </div>

  <!-- Normalization suggestions -->
  <div id="suggestions-group" style="display: none; margin: 20px 0;">
    <h3>Normalization Suggestions</h3>
    <div id="suggestions-container">
      <!-- Suggestions will be dynamically populated here -->
    </div>
  </div>

  <!-- Empty state -->
  <div id="empty-message" class="empty-message" style="display: none;">
    No variant groups found. All creator names appear to be consistent.
  </div>

  <!-- Action buttons -->
  <div style="text-align: right; margin-top: 20px;">
    <button id="apply-button" disabled>Apply Selected</button>
    <button id="cancel-button">Cancel</button>
  </div>

  <script type="application/javascript" src="chrome://zoteroner/content/scripts/zotero-ner-bundled.js"></script>
  <script type="application/javascript">
    /* global Zotero, ZoteroNER */

    // HTML DOM utils
    const ZoteroNER_HTMLUtils = {
      getElement: function(id) {
        return document.getElementById(id);
      },
      createElement: function(tagName, attributes = {}) {
        const el = document.createElement(tagName);
        for (const [key, value] of Object.entries(attributes)) {
          el.setAttribute(key, value);
        }
        return el;
      },
      appendTo: function(parentId, child) {
        const parent = this.getElement(parentId);
        if (parent) parent.appendChild(child);
      },
      clearContainer: function(id) {
        const container = this.getElement(id);
        if (container) container.innerHTML = '';
      },
      setText: function(id, text) {
        const el = this.getElement(id);
        if (el) el.textContent = text;
      },
      setHidden: function(id, hidden) {
        const el = this.getElement(id);
        if (el) el.style.display = hidden ? 'none' : 'block';
      },
      updateProgressBar: function(percent) {
        const fill = document.getElementById('progress-fill');
        if (fill) fill.style.width = percent + '%';
      },
      updateProgressLabel: function(text) {
        const label = document.getElementById('progress-label');
        if (label) label.textContent = text;
      }
    };

    // Embedded controller
    var ZoteroNER_NormalizationDialog = {
      dbAnalyzer: null,
      isProcessing: false,
      selectedVariantGroupIndex: 0,
  analysisResults: null,
  items: null,
  analysisResultsSource: null,

      init: function() {
        console.log('Dialog initialization started');
        Promise.resolve(this.initialize()).catch((error) => {
          console.error(error);
          this.alert('Error', 'Failed to initialize: ' + error.message);
          window.close();
        });
      },

      unwrapDialogParams: function(raw) {
        if (!raw) {
          return raw;
        }

        try {
          if (raw.wrappedJSObject) {
            return raw.wrappedJSObject;
          }
        } catch (err) {
          this.log('Failed to access wrappedJSObject: ' + err.message);
        }

        if (typeof raw.getProperty === 'function') {
          try {
            const wrapped = raw.getProperty('wrappedJSObject');
            if (wrapped) {
              return wrapped;
            }
          } catch (err) {
            this.log('No wrappedJSObject property in param bag: ' + err.message);
          }

          let items;
          let analysisResults;
          let analysisResultsJSON;

          try {
            items = raw.getProperty('items');
          } catch (err) {
            this.log('Unable to read items from param bag: ' + err.message);
          }

          try {
            analysisResults = raw.getProperty('analysisResults');
          } catch (err) {
            this.log('Unable to read analysisResults from param bag: ' + err.message);
          }

          try {
            analysisResultsJSON = raw.getProperty('analysisResultsJSON');
          } catch (err) {
            this.log('Unable to read analysisResultsJSON from param bag: ' + err.message);
          }

          if (analysisResultsJSON || analysisResults || items) {
            return {
              items,
              analysisResults,
              analysisResultsJSON
            };
          }
        }

        return raw;
      },

      sanitizeAnalysisResults: function(value, contextLabel = 'analysis results') {
        if (!value || typeof value !== 'object') {
          return null;
        }

        try {
          const plain = JSON.parse(JSON.stringify(value));
          this.log('Sanitized ' + contextLabel + ' (suggestions: ' + ((plain && Array.isArray(plain.suggestions)) ? plain.suggestions.length : 'unknown') + ')');
          return plain;
        } catch (err) {
          this.log('Failed to sanitize ' + contextLabel + ': ' + err.message);
        }

        return null;
      },

      safeParseJSON: function(jsonString, contextLabel = 'analysisResultsJSON') {
        if (!jsonString || typeof jsonString !== 'string') {
          return null;
        }

        try {
          const parsed = JSON.parse(jsonString);
          this.log('Parsed ' + contextLabel + ' (suggestions: ' + ((parsed && Array.isArray(parsed.suggestions)) ? parsed.suggestions.length : 'unknown') + ')');
          return parsed;
        } catch (err) {
          this.log('Failed to parse ' + contextLabel + ': ' + err.message);
        }

        return null;
      },

      resolveAnalysisResults: function(params, contextLabel = 'dialog params') {
        if (!params) {
          return null;
        }

        if (params.analysisResults && typeof params.analysisResults === 'object') {
          const sanitized = this.sanitizeAnalysisResults(params.analysisResults, contextLabel + '.analysisResults');
          if (sanitized) {
            this.analysisResultsSource = contextLabel + '.analysisResults';
            return sanitized;
          }
        }

        if (params.analysisResultsJSON) {
          const parsed = this.safeParseJSON(params.analysisResultsJSON, contextLabel + '.analysisResultsJSON');
          if (parsed) {
            this.analysisResultsSource = contextLabel + '.analysisResultsJSON';
            return parsed;
          }
        }

        return null;
      },

      log: function(message) {
        console.log('Zotero NER Dialog: ' + message);
        try {
          if (typeof Zotero !== 'undefined' && typeof Zotero.debug === 'function') {
            Zotero.debug('Zotero NER Dialog: ' + message);
          }
        } catch (e) {}
      },

      alert: function(title, message) {
        try {
          if (typeof Zotero !== 'undefined' && typeof Zotero.alert === 'function') {
            Zotero.alert(null, title, message);
          } else {
            window.alert(title + ': ' + message);
          }
        } catch (e) {
          window.alert(title + ': ' + message);
        }
      },
      
      initialize: async function() {
        this.log('Dialog initialize started');

        let params = null;

        try {
          if (typeof window.arguments !== 'undefined' && window.arguments.length > 0) {
            params = window.arguments[0];
          }
        } catch (err) {
          this.log('Unable to read window arguments: ' + err.message);
        }

        if (params) {
          params = this.unwrapDialogParams(params);
        }

        if (!params && window.ZoteroNERDialogParams) {
          params = this.unwrapDialogParams(window.ZoteroNERDialogParams);
        }

        if (!params && window.ZoteroNERDialogParamsJSON) {
          params = { analysisResultsJSON: window.ZoteroNERDialogParamsJSON };
        }

        if (!params && window.opener) {
          try {
            if (window.opener.ZoteroNERDialogParams) {
              params = this.unwrapDialogParams(window.opener.ZoteroNERDialogParams);
            }
          } catch (err) {
            this.log('Unable to read ZoteroNERDialogParams from opener: ' + err.message);
          }
        }

        if (!params && window.opener && window.opener.ZoteroNERDialogParamsJSON) {
          params = { analysisResultsJSON: window.opener.ZoteroNERDialogParamsJSON };
        }

        if (!params && window.opener && window.opener.ZoteroNERAnalysisResultsJSON) {
          params = { analysisResultsJSON: window.opener.ZoteroNERAnalysisResultsJSON };
        }

        if (!params && window.opener && window.opener.ZoteroNERAnalysisResults) {
          const sanitized = this.sanitizeAnalysisResults(window.opener.ZoteroNERAnalysisResults, 'opener.ZoteroNERAnalysisResults');
          if (sanitized) {
            params = { analysisResults: sanitized };
          }
        }

        if (!params && window.ZoteroNERAnalysisResultsJSON) {
          params = { analysisResultsJSON: window.ZoteroNERAnalysisResultsJSON };
        }

        if (!params && window.ZoteroNERAnalysisResults) {
          const sanitizedCurrent = this.sanitizeAnalysisResults(window.ZoteroNERAnalysisResults, 'window.ZoteroNERAnalysisResults');
          if (sanitizedCurrent) {
            params = { analysisResults: sanitizedCurrent };
          }
        }

        let analysisResults = null;
        if (params) {
          analysisResults = this.resolveAnalysisResults(params, 'dialog params');

          if (!analysisResults && !params.analysisResults && !params.analysisResultsJSON) {
            const direct = this.sanitizeAnalysisResults(params, 'dialog params direct');
            if (direct) {
              analysisResults = direct;
              this.analysisResultsSource = 'dialog params direct';
            }
          }

          if (params.items) {
            this.items = params.items;
          }
        }

        if (!analysisResults && window.opener && window.opener.ZoteroNERAnalysisResultsJSON) {
          analysisResults = this.safeParseJSON(window.opener.ZoteroNERAnalysisResultsJSON, 'opener.ZoteroNERAnalysisResultsJSON');
        }

        if (!analysisResults && window.opener && window.opener.ZoteroNERAnalysisResults) {
          analysisResults = this.sanitizeAnalysisResults(window.opener.ZoteroNERAnalysisResults, 'opener.ZoteroNERAnalysisResults direct');
        }

        if (!analysisResults && window.ZoteroNERAnalysisResultsJSON) {
          analysisResults = this.safeParseJSON(window.ZoteroNERAnalysisResultsJSON, 'window.ZoteroNERAnalysisResultsJSON');
        }

        if (!analysisResults && window.ZoteroNERAnalysisResults) {
          analysisResults = this.sanitizeAnalysisResults(window.ZoteroNERAnalysisResults, 'window.ZoteroNERAnalysisResults direct');
        }

        this.analysisResults = analysisResults;

        if (!this.analysisResults) {
          this.log('No analysis results found');
          this.showEmptyState('No analysis results were provided to the dialog.');
          this.updateProgress();
          return;
        }

        this.log('Analysis results source: ' + (this.analysisResultsSource || 'unknown'));
        this.log('Analysis results loaded: ' + (this.analysisResults.suggestions ? this.analysisResults.suggestions.length : 0) + ' suggestions; unique surnames: ' + (this.analysisResults.totalUniqueSurnames ?? 'unknown'));

        this.updateSummaryHeader();
        const hasVariantGroups = this.populateVariantGroupList();
        if (hasVariantGroups) {
          this.renderCurrentVariantGroup();
        }
        this.updateProgress();
      },

      showEmptyState: function(message) {
        if (this.analysisResults) {
          this.updateSummaryHeader();
        } else {
          ZoteroNER_HTMLUtils.setHidden('summary-group', true);
        }

        ZoteroNER_HTMLUtils.clearContainer('variant-group-list');
        const suggestionsContainer = ZoteroNER_HTMLUtils.getElement('suggestions-container');
        if (suggestionsContainer) {
          suggestionsContainer.innerHTML = '';
        }
        ZoteroNER_HTMLUtils.setHidden('suggestions-group', true);

        this.setApplyEnabled(false);

        const emptyMsg = ZoteroNER_HTMLUtils.getElement('empty-message');
        if (emptyMsg) {
          const frequencies = this.analysisResults && this.analysisResults.surnameFrequencies
            ? Object.entries(this.analysisResults.surnameFrequencies)
            : [];
          const totalUnique = this.analysisResults && typeof this.analysisResults.totalUniqueSurnames === 'number'
            ? this.analysisResults.totalUniqueSurnames
            : 0;
          const topFrequencies = frequencies
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

          let html = '<div class="empty-message-content">';
          html += `<p>${message || 'No variant groups found. All creator names appear to be consistent.'}</p>`;

          if (totalUnique) {
            html += `<p><strong>Total unique surnames scanned:</strong> ${totalUnique}</p>`;
          }

          if (topFrequencies.length > 0) {
            html += '<p><strong>Top surnames by frequency:</strong></p>';
            html += '<ul class="surname-frequency-list">';
            topFrequencies.forEach(([name, count]) => {
              html += `<li><span class="surname">${this.formatSurnameKey(name)}</span> <span class="frequency">(${count})</span></li>`;
            });
            html += '</ul>';
          }

          html += '</div>';
          emptyMsg.innerHTML = html;
          emptyMsg.style.display = 'block';
        }
      },

      updateSummaryHeader: function() {
        if (!this.analysisResults) return;

        ZoteroNER_HTMLUtils.setHidden('summary-group', false);
        ZoteroNER_HTMLUtils.setText('summary-total-creators', this.analysisResults.totalUniqueSurnames || '0');
        ZoteroNER_HTMLUtils.setText('summary-variant-groups', this.analysisResults.totalVariantGroups || '0');
        ZoteroNER_HTMLUtils.setText('summary-pending-normalizations', this.analysisResults.suggestions ? this.analysisResults.suggestions.length : '0');
      },

      populateVariantGroupList: function() {
        const list = ZoteroNER_HTMLUtils.getElement('variant-group-list');
        if (list) {
          ZoteroNER_HTMLUtils.clearContainer('variant-group-list');
        }

        const emptyMsg = ZoteroNER_HTMLUtils.getElement('empty-message');
        if (emptyMsg) {
          emptyMsg.style.display = 'none';
        }

        if (!this.analysisResults || !Array.isArray(this.analysisResults.suggestions) || this.analysisResults.suggestions.length === 0) {
          this.showEmptyState('No variant groups were detected for the scanned surnames.');
          return false;
        }

        if (!list) return false;

        this.analysisResults.suggestions.forEach((suggestion, i) => {
          const listItem = ZoteroNER_HTMLUtils.createElement('li', { 
            class: 'zotero-ner-variant-group',
            'data-index': i 
          });
          const container = ZoteroNER_HTMLUtils.createElement('div', { class: 'zotero-ner-variant-group-body' });

          const title = ZoteroNER_HTMLUtils.createElement('h4', { class: 'zotero-ner-variant-group-title' });
          title.textContent = `Variant group ${i + 1}`;

          const primary = ZoteroNER_HTMLUtils.createElement('div', { class: 'zotero-ner-variant-group-primary primary' });
          const primaryName = this.escapeHTML(this.formatNameString(suggestion.primary));
          primary.innerHTML = '<strong>Primary:</strong> ' + primaryName;

          const variantsDiv = ZoteroNER_HTMLUtils.createElement('div', { class: 'zotero-ner-variant-group-variants' });
          const variantNames = suggestion.variants
            .map(v => {
              const variantName = this.escapeHTML(this.formatNameString(v.name));
              return `<span class="variant">${variantName} <span class="frequency">(${v.frequency})</span></span>`;
            })
            .join(', ');
          variantsDiv.innerHTML = '<strong>Variants:</strong> ' + variantNames;

          container.appendChild(title);
          container.appendChild(primary);
          container.appendChild(variantsDiv);
          listItem.appendChild(container);
          list.appendChild(listItem);
        });

        this.highlightVariantGroup();
        return true;
      },

      renderCurrentVariantGroup: function() {
        if (!this.analysisResults || !this.analysisResults.suggestions || this.analysisResults.suggestions.length === 0) {
          this.setApplyEnabled(false);
          return;
        }

        const index = this.selectedVariantGroupIndex || 0;
        const suggestion = this.analysisResults.suggestions[index];

        const container = ZoteroNER_HTMLUtils.getElement('suggestions-container');
        if (!container) return;

        ZoteroNER_HTMLUtils.clearContainer('suggestions-container');
        ZoteroNER_HTMLUtils.setHidden('suggestions-group', false);

        const groupDiv = ZoteroNER_HTMLUtils.createElement('div', { class: 'variant-group ner-creator-group' });
        const caption = ZoteroNER_HTMLUtils.createElement('h4');
        caption.textContent = 'Variant Group ' + (index + 1);
        groupDiv.appendChild(caption);

        const body = ZoteroNER_HTMLUtils.createElement('div', { class: 'ner-creator-body' });

        // Primary
        const primaryLabel = ZoteroNER_HTMLUtils.createElement('div', { class: 'primary ner-creator-original' });
  const primaryName = this.escapeHTML(this.formatNameString(suggestion.primary));
  primaryLabel.innerHTML = 'Recommended normalization: <strong>' + primaryName + '</strong>';
        body.appendChild(primaryLabel);

        // Radio group
        const choiceGroup = ZoteroNER_HTMLUtils.createElement('div', { class: 'radio-group', id: 'ner-variant-group-choice-' + index });

        // Primary radio
        const primaryRadioDiv = ZoteroNER_HTMLUtils.createElement('div');
        const primaryRadio = ZoteroNER_HTMLUtils.createElement('input', { type: 'radio', value: 'primary', name: 'choice-' + index, checked: 'checked' });
        const primaryLabelEl = ZoteroNER_HTMLUtils.createElement('label');
        primaryLabelEl.textContent = 'Use recommended normalization: ' + this.formatNameString(suggestion.primary);
        primaryRadioDiv.appendChild(primaryRadio);
        primaryRadioDiv.appendChild(primaryLabelEl);
        choiceGroup.appendChild(primaryRadioDiv);

        // Keep original
        const keepDiv = ZoteroNER_HTMLUtils.createElement('div');
        const keepRadio = ZoteroNER_HTMLUtils.createElement('input', { type: 'radio', value: 'original', name: 'choice-' + index });
        const keepLabel = ZoteroNER_HTMLUtils.createElement('label');
        keepLabel.textContent = 'Keep existing forms as-is';
        keepDiv.appendChild(keepRadio);
        keepDiv.appendChild(keepLabel);
        choiceGroup.appendChild(keepDiv);

        // Variants
        if (suggestion.variants && suggestion.variants.length > 0) {
          const variantsLabel = ZoteroNER_HTMLUtils.createElement('label', { class: 'ner-creator-meta' });
          variantsLabel.textContent = 'Variants in this group:';
          body.appendChild(variantsLabel);

          suggestion.variants.forEach((v, j) => {
            const vDiv = ZoteroNER_HTMLUtils.createElement('div');
            const vRadio = ZoteroNER_HTMLUtils.createElement('input', { type: 'radio', value: 'variant-' + j, name: 'choice-' + index });
            const vLabel = ZoteroNER_HTMLUtils.createElement('label');
            vLabel.textContent = this.formatNameString(v.name) + ' â€¢ ' + v.frequency + ' occurrences';
            vDiv.appendChild(vRadio);
            vDiv.appendChild(vLabel);
            choiceGroup.appendChild(vDiv);
          });
        }

        body.appendChild(choiceGroup);

        // Confidence
        if (typeof suggestion.similarity === 'number') {
          const confLabel = ZoteroNER_HTMLUtils.createElement('div', { class: 'ner-creator-meta confidence' });
          confLabel.textContent = 'Group confidence: ' + Math.round(suggestion.similarity * 100) + '%';
          body.appendChild(confLabel);
        }

        groupDiv.appendChild(body);
        container.appendChild(groupDiv);

        this.setApplyEnabled(true);
      },

      highlightVariantGroup: function() {
        const list = ZoteroNER_HTMLUtils.getElement('variant-group-list');
        if (!list) return;

        const items = list.querySelectorAll('li[data-index]');
        if (items[this.selectedVariantGroupIndex]) {
          items[this.selectedVariantGroupIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          items.forEach((item, idx) => item.classList.toggle('selected', idx === this.selectedVariantGroupIndex));
        }
      },

      formatNameString: function(name) {
        if (typeof name === 'string') return name.trim();
        if (name && typeof name === 'object') {
          return `${name.firstName || ''} ${name.lastName || ''}`.trim();
        }
        return '';
      },

      escapeHTML: function(value) {
        if (typeof value !== 'string') {
          return '';
        }
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return value.replace(/[&<>"']/g, (char) => map[char]);
      },

      formatSurnameKey: function(value) {
        if (!value || typeof value !== 'string') {
          return '';
        }
        const titleCased = value
          .split(/\s+/)
          .filter(Boolean)
          .map(part => part.charAt(0).toUpperCase() + part.slice(1))
          .join(' ');
        return this.escapeHTML(titleCased);
      },

      setApplyEnabled: function(enabled) {
        const applyButton = ZoteroNER_HTMLUtils.getElement('apply-button');
        if (applyButton) applyButton.disabled = !enabled || this.isProcessing;
      },

      setDialogBusy: function(isBusy) {
        this.isProcessing = isBusy;
        ZoteroNER_HTMLUtils.setHidden('progress-container', !isBusy);

        const applyButton = ZoteroNER_HTMLUtils.getElement('apply-button');
        if (applyButton) applyButton.disabled = isBusy;
      },

      updateProgress: function() {
        const progressLabel = ZoteroNER_HTMLUtils.getElement('progress-label');
        if (!progressLabel) return;

        if (this.analysisResults && this.analysisResults.suggestions) {
          if (this.isProcessing) {
            ZoteroNER_HTMLUtils.updateProgressBar(50);
            ZoteroNER_HTMLUtils.updateProgressLabel('Applying normalizations...');
          } else {
            ZoteroNER_HTMLUtils.updateProgressBar(100);
            ZoteroNER_HTMLUtils.updateProgressLabel('Analysis complete: ' + this.analysisResults.suggestions.length + ' variant groups found');
          }
        } else if (this.isProcessing) {
          ZoteroNER_HTMLUtils.updateProgressBar(50);
          ZoteroNER_HTMLUtils.updateProgressLabel('Analyzing library...');
        } else {
          ZoteroNER_HTMLUtils.updateProgressBar(0);
          ZoteroNER_HTMLUtils.updateProgressLabel('Ready');
        }
      },

      applySelected: async function() {
        if (this.isProcessing || !this.analysisResults) return;

        this.setDialogBusy(true);

        try {
          if (typeof ZoteroNER !== 'undefined' && ZoteroNER.ZoteroDBAnalyzer) {
            this.dbAnalyzer = new ZoteroNER.ZoteroDBAnalyzer();
          }

          const results = await this.dbAnalyzer.applyNormalizationSuggestions(this.analysisResults.suggestions, false);

          this.alert('NER Author Name Normalizer',
            'Normalization suggestions applied!\n\n' +
            'Total suggestions: ' + results.totalSuggestions + '\n' +
            'Applied: ' + results.applied + '\n' +
            'Skipped: ' + results.skipped + '\n' +
            'Errors: ' + results.errors);

        } catch (error) {
          console.error(error);
          this.alert('Error', 'Failed to apply: ' + error.message);
        } finally {
          this.setDialogBusy(false);
          window.close();
        }
      }
    };

    // Event listeners
    document.getElementById('apply-button').addEventListener('click', function() {
      ZoteroNER_NormalizationDialog.applySelected();
    });

    document.getElementById('cancel-button').addEventListener('click', function() {
      window.close();
    });

    // Start
    ZoteroNER_NormalizationDialog.init();
  </script>
</body>
</html>